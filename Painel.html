<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LAB-NEXUS :: Cart√≥rio C137</title>
<link rel="stylesheet" href="https://guilabriolag.github.io/Lab-Nexus/css/nexus-core.css">
<style>
  /* Inje√ß√£o de Estilo Cr√≠tico para funcionamento imediato */
  :root { --cyan: #00F2FF; --gold: #FFD700; --bg: #050505; }
  body { background: var(--bg); color: #e6e6e6; font-family: 'JetBrains Mono', monospace; margin: 0; }
  header { padding: 15px; border-bottom: 1px solid rgba(0,242,255,0.2); background: #080808; }
  .reality-card { background: #0b0b0b; border: 1px solid rgba(0,242,255,0.1); border-radius: 8px; padding: 15px; margin: 15px; transition: 0.3s; }
  .reality-card:hover { border-color: var(--cyan); box-shadow: 0 0 15px rgba(0,242,255,0.1); }
  .input-nexus { width: 100%; background: #111; border: 1px solid #333; color: var(--cyan); padding: 10px; border-radius: 5px; margin: 5px 0; }
  .btn-genesis { background: var(--cyan); color: #000; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; }
  nav { position: fixed; bottom: 0; width: 100%; background: #060606; display: flex; justify-content: space-around; padding: 10px; border-top: 1px solid rgba(0,242,255,0.2); }
  .nav-item { text-align: center; font-size: 0.7rem; color: #777; cursor: pointer; }
  .nav-item.active { color: var(--cyan); }
  #modal-genesis { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); padding:20px; z-index:100; }
</style>
</head>
<body>

<header>
  <div id="did" style="font-size:0.7rem; color:var(--cyan)">did:nexus:btc:carregando...</div>
  <div id="connection-status" style="font-size:0.6rem; color:#777">BUNKER ONLINE</div>
</header>

<main id="app">
  <div id="realities-grid"></div>
</main>

<div id="modal-genesis">
  <h2 style="color:var(--cyan)">üìù G√äNESIS DE REALIDADE</h2>
  <input type="text" id="reg-title" class="input-nexus" placeholder="T√≠tulo do Registro">
  <textarea id="reg-content" class="input-nexus" rows="8" placeholder="Conte√∫do da Realidade..."></textarea>
  <button class="btn-genesis" onclick="processarGenesis()">SELAR REALIDADE</button>
  <button onclick="toggleGenesis()" style="background:none; border:none; color:#777; margin-top:10px; width:100%">CANCELAR</button>
</div>

<nav>
  <div class="nav-item active" onclick="toggleGenesis()"><span>üìù</span><br>G√™nesis</div>
  <div class="nav-item"><span>‚ö°</span><br>Sats</div>
  <div class="nav-item" onclick="exportarLivro()"><span>üìñ</span><br>Exportar</div>
  <div class="nav-item"><span>üîê</span><br>Vault</div>
</nav>

<script src="https://guilabriolag.github.io/Lab-Nexus/js/core-immutability.js"></script>
<script>
  // ESTADO GLOBAL (Herdado do McClone)
  let STATE = {
    registros: JSON.parse(localStorage.getItem('nexus_registros')) || []
  };

  function saveAll() {
    localStorage.setItem('nexus_registros', JSON.stringify(STATE.registros));
  }

  function toggleGenesis() {
    const m = document.getElementById('modal-genesis');
    m.style.display = m.style.display === 'block' ? 'none' : 'block';
  }

  // A FUN√á√ÉO MESTRE: Transformando texto em Realidade Selada
  async function processarGenesis() {
    const title = document.getElementById('reg-title').value;
    const content = document.getElementById('reg-content').value;

    if(!title || !content) return alert("Campos incompletos.");

    // Gerando Hash Real (SHA-256)
    const encoder = new TextEncoder();
    const data = encoder.encode(content);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

    const novoRegistro = {
      uuid: crypto.randomUUID(),
      title: title,
      body: content,
      hash: hashHex,
      timestamp: Date.now(),
      status: "LOCKED"
    };

    STATE.registros.unshift(novoRegistro);
    saveAll();
    render();
    toggleGenesis();
    if(navigator.vibrate) navigator.vibrate(50);
  }

  function render() {
    const grid = document.getElementById('realities-grid');
    grid.innerHTML = STATE.registros.map(reg => `
      <div class="reality-card" onclick="verGrimorio('${reg.uuid}')">
        <div class="reality-title">${reg.title}</div>
        <div class="reality-hash" style="font-size:0.6rem; color:var(--cyan)">${reg.hash.slice(0,24)}...</div>
        <div style="font-size:0.6rem; color:var(--gold); margin-top:5px">üìú IMUT√ÅVEL</div>
      </div>
    `).join('');
  }

  function verGrimorio(id) {
    localStorage.setItem('grimorio_open', id);
    window.location.href = 'Grimorio.html';
  }

  function exportarLivro() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(STATE.registros));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "nexus_backup.json");
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
  }

  window.onload = render;
</script>
</body>
</html>
